%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%  Load the document class and packages                         %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper]{report}
\usepackage{epsfig} %to insert PostScript figures
\graphicspath{ 
  {figures/} 
}

%Change figure names
\renewcommand{\figurename}{Fig}

\usepackage[bf,footnotesize]{caption} % make captions small and label bold


\addtocounter{chapter}{1} %Because starting at zero is silly
\makeatletter
\renewcommand{\thesection}{\@arabic\c@section}
\renewcommand{\thefigure}{\@arabic\c@figure}
\makeatother

\usepackage[a4paper,margin=2.7cm,tmargin=2.5cm,bmargin=2.5cm]{geometry} 
\usepackage{textcomp}  %To make nice degree symbols and others\usepackage[bf,footnotesize]{caption} % make captions small and label bold
\usepackage{wrapfig}
\usepackage[ps2pdf,bookmarks=TRUE]{hyperref} 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%  Hypertext references for Acrobat                             %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\hypersetup{
pdfauthor = {TENSS},
pdftitle = {Benchtop Scanning},
pdfkeywords = {optics, lenses, refraction, reflection, dispersion,
  telescope, microscope},
pdfcreator = {LaTeX with hyperref},
pdfproducer = {dvips + ps2pdf}
           }


\begin{document}




%set the number of sectioning levels 
\setcounter{secnumdepth}{2}

\begin{center}
\textbf{\Large{Benchtop Scanning}}
\end{center}

\section{Introduction}

In widefield microscopy the entire field of view is illuminated and a great deal of scattered light from outside of the focal plane ends up in the image plane. 
Recall that in an image-forming condition \textbf{light rays leaving one point (or region) of the object arrive at some other defined point (or region)}.
Scattered photons fail to satisfy the image-forming condition because they arrive at the image plane at a location \textit{not conjugate} with their origin.
Photons that are not scattered are known ballistic photons. 

Fluorescence-based scanning microscopy greatly mitigates the problem of scattering. 
A laser beam is scanned across the sample and excites a fluorophore. 
Emitted fluorescence is collected via the objective, separated from the excitation light by a dichroic, and detected at a photomultiplier tube (PMT). 
No image is formed on the PMT (it's a `single pixel'), instead the image is constructed \textit{post-hoc} on a computer.
Indeed, in many scanning microscopes the object and the PMT are not even at conjugate planes.
With confocal, the scattered light is rejected by the pinhole. 
With 2-photon, the excitation volume is highly restricted so the origin of all collected photons is known. 




\subsection{Building a transmission scanning microscope}
You will now build a transmitted light scanning microscope using a laser pointer and a photodiode located after the sample. 
This setup of course provides none of the advantages of a scanning microscope, but the arrangement of the excitation path is identical to that found in the 2-photon microscope you will go on to build. 
The goals of this exercise are for you to become more familiar with data acquisition, learn how to drive the scan mirrors and how to build an image from the incoming detector data. 

\section{Set up the scanners and align the beam}
Set up the rail and scanners as follows:
\begin{itemize}
\setlength\itemsep{0.15em}
\item Bolt the optical rail to the breadboard using a clamp on each end. Do not over-tighten. 
\item Place two irises on the ends of the rail and set them to the same height. 
Locating them on fully lowered $75~mm$ posts is suitable. 
\item Place the the scanners at one end of the rail.
The scanners need to be powered and the command inputs at 0 V for the mirrors to be square with respect to each other. 
\item You may end up needing to the move the rail or the scanners during the alignment procedure.
\end{itemize}

\vspace{1.5em}

You will route the laser beam into the scanners via two two mirrors. 
The mirrors provide fine positioning control: your goal is to have the beam hit the middle of the scan mirrors then go straight down the rail, parallel with the table. 
This will be easiest if you place one routing mirror close to the scanners and the other some distance away. 
Having all mirrors roughly square with respect to each other also helps.
The laser pointer is placed at 45 degrees going into the first routing mirror (that furthest from the scanners). 

Do the initial coarse alignment by moving and rotating the mirrors and the laser pointer. 
Then bolt down the components and use the fine-adjustment screws on the mirror mounts. 
You should not need to approach the limits of the adjustment screw travel range.
Use irises to ensure the beam runs straight down the rail. 
You will likely find that the scanners aren't aligned with the irises and that either they or the rail need to be moved. 
Expect to do the alignment procedure several times. 
It's OK for our purposes if the alignment isn't \textit{perfect}. 
Getting it to within a couple of beam diameters is quite adequate. 

\clearpage
\subsection{Add the optics}
You will use the 4X objective to image the scan pattern onto the sample using the objective's full NA. 
Two things need to be achieved in order to make this possible. 
\begin{enumerate}
\setlength\itemsep{0.1em}
\item The scan mirrors will need to be in a conjugate plane to the back aperture of the objective. 
\item The beam will need to be expanded to fill the back aperture of the objective. 
\end{enumerate}

These can be satisfied by building a beam expander between the objective and the scanners. 
The resulting arrangement is known as a $4f$ system. 
Place the objective mid-way down the rail and align it with the beam. Use an iris to guide you.
Choose suitable lenses for your beam expander: think how much you need to expand the beam. 
The lens nearer the scanners is called the \textbf{scan lens}.
The lens nearer the objective is called the \textbf{tube lens}.
The goal is to image the scanners onto the objective back aperture: how far should the scanners be from the scan lens and how far should the objective be from the tube lens?
You also want a collimated beam emerging from the tube lens: how far apart should the scan lens and tube lens be?

Insert the lenses. You may find it easiest to temporarily remove the objective, then insert the tube lens, then the scan lens, then the objective. 
Use cards or irises to guide lens insertion. 



\subsection{Verifying the beam motion}
\begin{itemize}
\item Connect the scan control cables to the analog outputs of your acquisition card. 
The smaller $x$ mirror is responsible for the `fast' axis and goes to AO0. The $y$ mirror is responsible for the slow axis and goes to to AO1. 
\item Start NI MAX, go to the test panels for your DAQ device and select analog output. 
\item Play a $50~Hz$ sine wave of amplitude $3~V$ through each channel in turn to check that the beam moves along both axes.
\item Use a card to observe the beam motion through the optical system. 
What do you see at $1f$ from the scan lens?
What do you see at the working distance of the objective?
What do you see at the objective back aperture?
Satisfy yourself that all those things make sense.
\end{itemize}

\clearpage

\section{Building the scan pattern}

You will now create and test various galvo waveforms using MATLAB. 
Wire up your DAQ and scanners as follows:

\begin{itemize}
    \item Hook up \texttt{AO0} to the $x$ galvo input terminal. This will drive the scanner. 
    \item Copy \texttt{AO0} to \texttt{AI0}. This will allow us to monitor the command signal.
    \item Connect \texttt{AI1} to the galvo position output lead. This will allow us to compare the actual mirror position with the command position.
\end{itemize}

Open the \texttt{waveformTester.m} file from SimpleMScanner and edit the \texttt{DAQDevice} property so it is the ID of your DAQ card. 
Now run \texttt{S=waveformTester;}, which will feed a sinusoidal command signal to the scanner. 
You will see a sinusoidal black trace overlaid by a sinusoidal red trace. 
The black is the command signal and the red is the galvo position. 
The inset blue sub-plot shows the position signal as a function of the command signal. 
The frequency of the waveform is displayed in the window title and at the command line. 
You can stop acquisition and disconnect from the DAQ by closing the figure window.

Read through the code and satisfy yourself that you understand how it works. 
Pay particular attention to how the waveform is built. 
The waveform amplitude is scaled by \texttt{galvoAmp}.
The property \texttt{pixelsPerLine} defines how many samples per line are used for the optional sawtooth waveform. 
For the current sine wave, \texttt{pixelsPerLine} is the number samples in one cycle. 
The waveform is repeated \texttt{numReps} times, so this many cycles are plotted at once. 
The \texttt{generateScanWaveform} method builds the waveform, which is either a sawtooth or a sine wave according to the value of \texttt{waveformType}.


\subsection{The effect of command signal frequency}
The scanners have inertia so their ability to follow the command waveform will depend upon its shape and frequency. 
Let's try changing the frequency. 
Close the figure window (take screenshot first if you want to compare before and after) and edit the \texttt{sampleRate} property.
Increase it to, say 128E3 ($128~kS/s$). 
Re-start the \texttt{waveformTester} object. 
Notice the larger lag between the position and command and how this is reflected in the blue X/Y plot. 
You can try higher sample rates, but some DAQ devices may refuse cooperate over about $200~kS/s$.


Let's now try having fewer samples per cycle, which is the other way of increasing the mirror frequency. 
Close the figure window, set \texttt{pixelsPerLine} to 128, and restart.
If your scanners can't keep up, try a larger value. 
At 128 \texttt{samplesPerLine} and $128~kS/s$ sample rate the scanner runs at $1~kHz$. 
There will be a big lag now. 
If your scanners will keep up, you can try lines as short as about 32 pixels, which is $4~kHz$. 
Turn off the scanner PSU if the scanners make a peculiar noise. 
Insufficient current supplied by the scanner PSU is one reason for the scanners not being able to follow higher frequencies.
Don't push beyond $4~kHz$ in case the scanners are damaged.
Also, don't try such high frequencies with other command waveform shapes.



\subsection{Synchronising AI and AO}
You will see in the code that the AI and AO tasks are set to run at the same clock speed. 
This is the easiest way of ensuring that the incoming data are synchronised with the output waveforms. 
We care about this because when we later build images we will do so by assigning pixels based upon the current galvo command voltage, not the position feedback.
Since the AO and AI tasks do not share a sample clock, it's possible to break the AO/AI synchronisation. 
Set \texttt{pixelsPerLine} to 128 and the sample rate to 128E3. 
All should look good. 
Now try a range of different, but similar, sample rates. e.g. try 117E3. 
Likely you will see a warning message and precession of the AI waveforms. 
Why is this happening?
Try fixing this by setting the AI and AO clocks to be shared as in the \texttt{polishedScanner} class. 
Verify that it's now possible to acquire data without precession taking place.


\subsection{Trying different waveforms}
Try a sawtooth waveform by modifying the \texttt{waveformType} property. 
Start with a frequency below $500~Hz$ then carefully try higher frequency (e.g. $2~kHz$). 
How well do the scanners follow the command signal?

The sawtooth waveform is commonly called a `unidirectional scan waveform' because we acquire data in one direction only (the slow ramp). 
What might a `bidirectional' waveform look like? i.e. A waveform that can be used to acquire data along both the outward going and reverse directions. 
Build this waveform by adding a case in the \texttt{generateScanWaveform} method. 
Does the scanner position signal better following control signal?


Your waveforms are what are known as `unshaped' waveforms, meaning that they incorporate no acceleration and deceleration at the turn-around periods. 
Adding this can improve the ability of the scanners to follow fast waveforms.
ScanImage uses shaped waveforms\footnote{The waveform signals themselves are stored in \texttt{hSI.hWaveformManager.scannerAO} of the ScanImage object.}.
Start ScanImage yourself or we will demo it. 
Explore scanning bidirectionally and uni-directionally. 
The line period is listed in the CONFIGURATION window and you can copy the galvo command signals to an oscilloscope to verify the amplitude. 
You can compare these waveforms to the ones you produced in a variety of ways: 
You will notice these waveforms produce much quieter scanning for a given amplitude and line period.
Can you see better tracking of the command and position waveforms on the scope?
Can you scan at faster speeds without the galvos cutting out? 


\subsection{Correcting image artifacts}
As briefly mentioned above, when we build images we will do so based on the command waveforms. 
In other words, we assume the beam is located where we asked it to be and we place the pixels at that location.
Since the actual beam position does not exactly follow the expected position, this presents us with a problem. 
As you have seen, the problem is worse at faster scan speeds and the form of the problem differs across the three waveform shapes you have worked with.

If don't take the the waveform shape into account the image will be distorted. 
How do we correct for this?
In theory we could use the feedback signal, but in practice doing so can introduce noise and it's generally not done (although you're welcome to try it). 
The alternative is to somehow modify the relationship of the command and position signals such that the points plotted on the blue overlay plot form a straight line.
Choose one or two waveform types and modify \texttt{readAndDisplayScanData} so that the relationship between command and position is close to a straight line. 
Hint: you can't always correct all the points, so will likely need to chop out some data points. 
If you're working with the sine wave, consider what effect the spacing between points could have.



\subsection{Obtaining images}
First set up the hardware to allow for image acquisition.
Place a slide containing an EM grid at the working distance of the objective. 
Place a photodiode close to the back of the slide and hook it up to \texttt{AI0} on your DAQ. 
You may get a better image with a collection lens in front of the detector, but this isn't critical\footnote{Or even K\"{o}hler, for that matter.}.
Try to focus the beam onto the grid.
Now it's time to get an image!
You have two choices.
\begin{enumerate}
    \item Set up and run \texttt{minimalScanner}. This should produce images right away. Then try \texttt{basicScanner} to see how artifacts are corrected.
    \item Add the code for controlling the $y$ mirror to \texttt{waveformTester} and modify the plotting code to show the image instead of the current line plot. 
    You can cheat and steal code from \texttt{basicScanner} as needed. 
\end{enumerate}

In either case you should finish up by looking at how \texttt{polishedScanner} allows changing in scan parameters on the fly. 
This ability was left out of \texttt{waveformTester} in order to keep the code as simple as possible.
Note also how \texttt{basicScanner} and \texttt{polishedScanner} save images to disk using \texttt{imwrite}.


\end{document}
